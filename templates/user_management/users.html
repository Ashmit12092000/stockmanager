{% extends "base.html" %}

{% block title %}User Management -  Stock Management{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h2 class="text-2xl font-bold leading-7 text-white sm:text-3xl sm:truncate">
                User Management
            </h2>
            <p class="mt-1 text-sm text-gray-400">
                Manage user accounts and role assignments
            </p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4 space-x-2">
            <button onclick="openCreateModal()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
                <i class="fas fa-plus mr-2"></i>Add User
            </button>
            <button onclick="openNetworkAdminModal()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none">
                <i class="fas fa-network-wired mr-2"></i>Add Manager/Executive
            </button>
        </div>
    </div>

    <!-- Users Table -->
    <div class="bg-gray-800 shadow overflow-hidden sm:rounded-md">
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">User</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Department</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-gray-800 divide-y divide-gray-700">
                {% for user in users %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10">
                                <div class="h-10 w-10 rounded-full bg-indigo-600 flex items-center justify-center">
                                    <span class="text-sm font-medium text-white">{{ user.full_name[0].upper() }}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-white">{{ user.full_name }}</div>
                                <div class="text-sm text-gray-400">{{ user.username }}</div>
                                <div class="text-sm text-gray-400">{{ user.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if user.role.value == 'superadmin' %}bg-purple-900 text-purple-200
                            {% elif user.role.value == 'manager' %}bg-blue-900 text-blue-200
                            {% elif user.role.value == 'hod' %}bg-green-900 text-green-200
                            {% else %}bg-gray-900 text-gray-200{% endif %}">
                            {{ user.role.value.replace('_', ' ').title() }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {% if user.department %}
                            {{ user.department.name }}
                        {% else %}
                            <span class="text-gray-500">Not assigned</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if user.is_active %}bg-green-900 text-green-200{% else %}bg-red-900 text-red-200{% endif %}">
                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        <div class="flex space-x-2">
                            <button onclick="openEditModal({{ user.id }}, '{{ user.username }}', '{{ user.email }}', '{{ user.role.value }}', {{ user.department_id if user.department_id else 'null' }}, {{ user.is_active|lower }}, {{ user.assigned_warehouses|map(attribute='id')|list|tojson }})"
                                    class="text-indigo-400 hover:text-indigo-300">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% if user.role.value != 'superadmin' or user.id == current_user.id %}
                            <button onclick="openPasswordModal({{ user.id }}, '{{ user.username }}')"
                                    class="text-yellow-400 hover:text-yellow-300">
                                <i class="fas fa-key"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-400">No users found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Create User Modal -->
<div id="createModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-gray-800">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-white mb-4">Add New User</h3>
            <form method="POST" action="{{ url_for('user_management.create_user') }}">
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Link to Employee (Optional)</label>
                    <select name="employee_id" id="createEmployeeSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" onchange="updateDepartmentFromEmployee(this, 'createDepartment')">
                        <option value="">No Employee Link</option>
                        {% for emp in unassigned_employees %}
                        <option value="{{ emp.id }}" data-department="{{ emp.department_id }}" data-department-name="{{ emp.department.name }}">{{ emp.emp_id }} - {{ emp.name }} ({{ emp.department.name }})</option>
                        {% endfor %}
                    </select>
                    <p class="text-gray-400 text-xs mt-1">Select an employee to automatically set their department</p>
                </div>
                <div class="mb-4" id="createDepartment">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Department (Optional)</label>
                    <select name="department_id" id="createDepartmentSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <option value="">No Department (Assign Later)</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-gray-400 text-xs mt-1" id="createDepartmentNote">You can assign departments later or select an employee to auto-populate</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Role*</label>
                    <select name="role" id="createRole" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" onchange="toggleDepartmentField(this, 'createDepartment')">
                        <option value="">Select Role</option>

                        <option value="superadmin">Superadmin</option>
                        <option value="manager">Manager/Executives</option>
                        <option value="hod">HOD</option>
                        <option value="employee">Employee</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Username*</label>
                    <input type="text" name="username" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Password*</label>
                    <input type="password" name="password" required minlength="6" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Email*</label>
                    <input type="email" name="email" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mb-4" id="createWarehouseSection">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Assign Warehouses (Optional)</label>
                    <div class="max-h-32 overflow-y-auto bg-gray-700 border border-gray-600 rounded-md p-2">
                        {% for location in locations %}
                        <label class="flex items-center mb-2 text-sm">
                            <input type="checkbox" name="warehouse_ids" value="{{ location.id }}" class="rounded bg-gray-700 border-gray-600 text-indigo-600 focus:border-indigo-500 focus:ring-indigo-500 mr-2 create-warehouse-checkbox">
                            <span class="text-white">{{ location.code }} - {{ location.office }}, {{ location.room }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <p class="text-gray-400 text-xs mt-1">Select warehouses this user can access</p>
                    <p id="createAutoAssignNote" class="hidden text-green-400 text-xs mt-1">All warehouses are automatically assigned to this role.</p>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeCreateModal()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-gray-800 max-h-screen overflow-y-auto">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-white mb-4">Edit User</h3>
            <form method="POST" id="editForm">
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Username</label>
                    <input type="text" id="editUsername" disabled class="w-full px-3 py-2 bg-gray-600 border border-gray-500 rounded-md text-gray-400">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Email*</label>
                    <input type="email" name="email" id="editEmail" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Role*</label>
                    <select name="role" id="editRole" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white" onchange="toggleDepartmentField(this, 'editDepartment')">
                        <option value="superadmin">Superadmin</option>
                        <option value="manager">Manager/Executive</option>
                        <option value="hod">HOD</option>
                        <option value="employee">Employee</option>
                    </select>
                </div>
                <div class="mb-4" id="editDepartment">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Department</label>
                    <select name="department_id" id="editDepartmentSelect" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-4" id="editWarehouseSection">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Assign Warehouses (Optional)</label>
                    <div class="max-h-32 overflow-y-auto bg-gray-700 border border-gray-600 rounded-md p-2">
                        {% for location in locations %}
                        <label class="flex items-center mb-2 text-sm">
                            <input type="checkbox" name="warehouse_ids" value="{{ location.id }}" class="rounded bg-gray-700 border-gray-600 text-indigo-600 focus:border-indigo-500 focus:ring-indigo-500 mr-2 edit-warehouse-checkbox">
                            <span class="text-white">{{ location.code }} - {{ location.office }}, {{ location.room }}</span>
                        </label>
                        {% endfor %}
                    </div>
                    <p class="text-gray-400 text-xs mt-1">Select warehouses this user can access</p>
                    <p id="editAutoAssignNote" class="hidden text-green-400 text-xs mt-1">All warehouses are automatically assigned to this role.</p>
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" name="is_active" id="editActive" class="rounded bg-gray-700 border-gray-600 text-indigo-600 focus:border-indigo-500 focus:ring-indigo-500">
                        <span class="ml-2 text-gray-300">Active</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Network Admin Modal -->
<div id="networkAdminModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-gray-800">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-white mb-4">Add Manager/Executive</h3>
            <form method="POST" action="{{ url_for('user_management.create_user') }}" id="managerForm">
                <input type="hidden" name="role" value="manager">
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Username*</label>
                    <input type="text" name="username" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Password*</label>
                    <input type="password" name="password" required minlength="6" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">Email*</label>
                    <input type="email" name="email" required class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="mb-4">
                    <div class="bg-blue-900 border border-blue-700 rounded-md p-3">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-400"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-blue-200">
                                    Manager/Executive Access
                                </h3>
                                <div class="mt-2 text-sm text-blue-300">
                                    <p>Managers/Executives will automatically have access to all warehouses and do not belong to any specific department.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Hidden inputs to assign all warehouses -->
                {% for location in locations %}
                <input type="hidden" name="warehouse_ids" value="{{ location.id }}">
                {% endfor %}
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closeNetworkAdminModal()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Create Manager/Executive</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Password Reset Modal -->
<div id="passwordModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-gray-800">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-white mb-4">Reset Password</h3>
            <form method="POST" id="passwordForm">
                <div class="mb-4">
                    <p class="text-sm text-gray-300 mb-2">User: <span id="passwordUsername" class="font-medium text-white"></span></p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-300 text-sm font-bold mb-2">New Password*</label>
                    <input type="password" name="new_password" required minlength="6" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white">
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" onclick="closePasswordModal()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700">Reset Password</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openCreateModal() {
    document.getElementById('createModal').classList.remove('hidden');
}

function closeCreateModal() {
    document.getElementById('createModal').classList.add('hidden');
}

function openEditModal(id, username, email, role, departmentId, isActive, warehouseIds = []) {
    try {
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = role;
        document.getElementById('editDepartmentSelect').value = departmentId || '';
        document.getElementById('editActive').checked = isActive;
        document.getElementById('editForm').action = '/admin/users/' + id + '/update';

        // Reset all warehouse checkboxes
        document.querySelectorAll('.edit-warehouse-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });

        // Set warehouse assignments
        if (warehouseIds && Array.isArray(warehouseIds) && warehouseIds.length > 0) {
            warehouseIds.forEach(warehouseId => {
                const checkbox = document.querySelector(`.edit-warehouse-checkbox[value="${warehouseId}"]`);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }

        toggleDepartmentField(document.getElementById('editRole'), 'editDepartment');
        document.getElementById('editModal').classList.remove('hidden');
    } catch (error) {
        console.error('Error opening edit modal:', error);
        alert('Error opening edit modal. Please refresh the page and try again.');
    }
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
}

function openPasswordModal(id, username) {
    document.getElementById('passwordUsername').textContent = username;
    document.getElementById('passwordForm').action = '/admin/users/' + id + '/reset-password';
    document.getElementById('passwordModal').classList.remove('hidden');
}

function closePasswordModal() {
    document.getElementById('passwordModal').classList.add('hidden');
}

function openNetworkAdminModal() {
    document.getElementById('networkAdminModal').classList.remove('hidden');
}

function closeNetworkAdminModal() {
    document.getElementById('networkAdminModal').classList.add('hidden');
}

function toggleDepartmentField(selectElement, departmentFieldId) {
    try {
        const departmentField = document.getElementById(departmentFieldId);
        const role = selectElement.value;

        if (role === 'hod' || role === 'employee') {
            departmentField.style.display = 'block';
            departmentField.querySelector('select').required = false;
        } else {
            departmentField.style.display = 'none';
            departmentField.querySelector('select').required = false;
        }

        // Update label based on role and handle employee section visibility for create modal
        if (departmentFieldId === 'createDepartment') {
            const employeeSection = document.getElementById('createEmployee');
            const departmentNote = document.getElementById('createDepartmentNote');
            if (role === 'employee') {
                if (employeeSection) employeeSection.style.display = 'block';
                departmentField.style.display = 'block'; // Ensure department is visible for employees
                departmentField.querySelector('select').required = false;
                if (departmentNote) {
                    departmentNote.textContent = 'Select an employee to auto-populate the department';
                    departmentNote.className = 'text-gray-400 text-xs mt-1';
                }
            } else if (role === 'hod') {
                if (employeeSection) employeeSection.style.display = 'none';
                departmentField.style.display = 'block';
                departmentField.querySelector('select').required = false;
                if (departmentNote) {
                    departmentNote.textContent = 'You can assign departments later or select an employee to auto-populate';
                    departmentNote.className = 'text-gray-400 text-xs mt-1';
                }
            } else { // superadmin, manager
                if (employeeSection) employeeSection.style.display = 'none';
                departmentField.style.display = 'none';
                departmentField.querySelector('select').required = false;
                if (departmentNote) {
                    departmentNote.textContent = 'Superadmin and Managers do not have specific departments';
                    departmentNote.className = 'text-gray-400 text-xs mt-1';
                }
            }
        }

        // Handle warehouse assignment visibility
        const warehouseSectionId = departmentFieldId.replace('Department', 'WarehouseSection');
        const warehouseSection = document.getElementById(warehouseSectionId);
        const autoAssignNoteId = departmentFieldId.replace('Department', 'AutoAssignNote');
        const autoAssignNote = document.getElementById(autoAssignNoteId);

        if (role === 'superadmin' || role === 'manager') {
            if (warehouseSection) warehouseSection.style.display = 'none';
            if (autoAssignNote) autoAssignNote.classList.remove('hidden');
        } else {
            if (warehouseSection) warehouseSection.style.display = 'block';
            if (autoAssignNote) autoAssignNote.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error in toggleDepartmentField:', error);
    }
}

function updateDepartmentFromEmployee(employeeSelect, departmentFieldId) {
    const selectedOption = employeeSelect.options[employeeSelect.selectedIndex];
    const departmentSelect = document.getElementById(departmentFieldId === 'createDepartment' ? 'createDepartmentSelect' : 'editDepartmentSelect');
    const departmentNote = document.getElementById(departmentFieldId === 'createDepartment' ? 'createDepartmentNote' : 'editDepartmentNote');
    const currentRoleSelect = document.getElementById(departmentFieldId === 'createDepartment' ? 'createRole' : 'editRole');
    const role = currentRoleSelect.value;

    if (selectedOption.value && selectedOption.dataset.department) {
        departmentSelect.value = selectedOption.dataset.department;
        departmentSelect.disabled = true;

        if (departmentNote) {
            departmentNote.textContent = `Auto-selected from employee: ${selectedOption.dataset.departmentName}`;
            departmentNote.className = 'text-green-400 text-xs mt-1';
        }
    } else {
        departmentSelect.disabled = false;
        departmentSelect.value = '';

        if (departmentNote) {
            if (role === 'employee') {
                departmentNote.textContent = 'Select an employee to auto-populate the department';
            } else {
                departmentNote.textContent = 'You can assign departments later or select an employee to auto-populate';
            }
            departmentNote.className = 'text-gray-400 text-xs mt-1';
        }
    }
}

// Initialize department and warehouse visibility on page load and when role is changed
function initializeUserForm(modalId, roleFieldId, departmentFieldId) {
    const roleSelect = document.getElementById(roleFieldId);
    const departmentField = document.getElementById(departmentFieldId);
    const departmentSelect = departmentField.querySelector('select');
    const departmentNote = document.getElementById(departmentFieldId + 'Note');
    const employeeSection = document.getElementById('createEmployee'); // Assuming employee section is only in create modal
    const warehouseSection = document.getElementById(departmentFieldId.replace('create', 'edit').replace('edit', 'create') + 'Section');
    const autoAssignNote = document.getElementById(departmentFieldId.replace('create', 'create').replace('edit', 'edit') + 'AutoAssignNote');

    if (roleSelect) {
        const role = roleSelect.value;

        // Department visibility
        if (role === 'hod' || role === 'employee') {
            departmentField.style.display = 'block';
            departmentSelect.required = false;
        } else {
            departmentField.style.display = 'none';
            departmentSelect.required = false;
        }

        // Employee section and department note for create modal
        if (modalId === 'createModal') {
            if (role === 'employee') {
                employeeSection.style.display = 'block';
                departmentField.style.display = 'block';
                departmentSelect.required = false;
                departmentNote.textContent = 'Select an employee to auto-populate the department';
                departmentNote.className = 'text-gray-400 text-xs mt-1';
            } else if (role === 'hod') {
                employeeSection.style.display = 'none';
                departmentField.style.display = 'block';
                departmentSelect.required = false;
                departmentNote.textContent = 'You can assign departments later or select an employee to auto-populate';
                departmentNote.className = 'text-gray-400 text-xs mt-1';
            } else { // superadmin, manager
                employeeSection.style.display = 'none';
                departmentField.style.display = 'none';
                departmentSelect.required = false;
                departmentNote.textContent = 'Superadmin and Managers do not have specific departments';
                departmentNote.className = 'text-gray-400 text-xs mt-1';
            }
        }

        // Warehouse visibility
        if (role === 'superadmin' || role === 'manager') {
            if (warehouseSection) warehouseSection.style.display = 'none';
            autoAssignNote.classList.remove('hidden');
        } else {
            if (warehouseSection) warehouseSection.style.display = 'block';
            autoAssignNote.classList.add('hidden');
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initializeUserForm('createModal', 'createRole', 'createDepartment');
    initializeUserForm('editModal', 'editRole', 'editDepartment');
});
</script>
{% endblock %}
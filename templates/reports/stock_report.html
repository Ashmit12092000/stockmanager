{% extends "base.html" %}

{% block title %}Stock Report - Stock Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-bar me-2"></i>Stock Report</h2>
                <div>
                    <button class="btn btn-outline-secondary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
                </div>
                <div class="card-body">
                    <form method="GET" class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Item Filter</label>
                            <input type="text" name="item" class="form-control" 
                                   placeholder="Search by item name..." value="{{ item_filter }}">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Location Filter</label>
                            <input type="text" name="location" class="form-control" 
                                   placeholder="Search by office..." value="{{ location_filter }}">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <div class="btn-group w-100">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-2"></i>Apply Filters
                                </button>
                                <a href="{{ url_for('main.stock_report') }}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>Clear
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="fas fa-cubes fa-2x mb-2"></i>
                    <h3>{{ stock_data|length }}</h3>
                    <p class="mb-0">Total Stock Items</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h3>{{ stock_data|selectattr('0.balance', 'greaterthan', 0)|list|length }}</h3>
                    <p class="mb-0">In Stock</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h3>{{ stock_data|selectattr('0.balance', 'lessthan', 6)|selectattr('0.balance', 'greaterthan', 0)|list|length }}</h3>
                    <p class="mb-0">Low Stock (1-5)</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="fas fa-times-circle fa-2x mb-2"></i>
                    <h3>{{ stock_data|selectattr('0.balance', 'equalto', 0)|list|length }}</h3>
                    <p class="mb-0">Out of Stock</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock Data Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Stock Balance Report</h5>
                    <small class="text-muted">{{ stock_data|length }} records found</small>
                </div>
                <div class="card-body">
                    {% if stock_data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="stockTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Item Code</th>
                                        <th>Item Name</th>
                                        <th>Make/Brand</th>
                                        <th>Location</th>
                                        <th>Office</th>
                                        <th>Room/Store</th>
                                        <th>Current Balance</th>
                                        <th>Status</th>
                                        <th>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for balance, item, location in stock_data %}
                                    <tr class="{% if balance.balance == 0 %}table-danger{% elif balance.balance <= 5 %}table-warning{% endif %}">
                                        <td><strong>{{ item.code }}</strong></td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.make or '-' }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ location.office }} - {{ location.room_store }}</span>
                                        </td>
                                        <td>{{ location.office }}</td>
                                        <td>{{ location.room_store }}</td>
                                        <td>
                                            <span class="badge fs-6 {% if balance.balance == 0 %}bg-danger{% elif balance.balance <= 5 %}bg-warning{% else %}bg-success{% endif %}">
                                                {{ balance.balance }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if balance.balance == 0 %}
                                                <span class="badge bg-danger">Out of Stock</span>
                                            {% elif balance.balance <= 5 %}
                                                <span class="badge bg-warning">Low Stock</span>
                                            {% else %}
                                                <span class="badge bg-success">In Stock</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ balance.updated_at.strftime('%Y-%m-%d %H:%M') if balance.updated_at else 'Never' }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No stock data found</h5>
                            <p class="text-muted">
                                {% if item_filter or location_filter %}
                                    No stock records match your filter criteria.
                                {% else %}
                                    No stock entries have been made yet.
                                {% endif %}
                            </p>
                            {% if not item_filter and not location_filter %}
                            <a href="{{ url_for('main.add_stock_entry') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add Stock Entry
                            </a>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    {% if stock_data %}
    <div class="row mt-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Stock Status Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Top Items by Stock Level</h5>
                </div>
                <div class="card-body">
                    <canvas id="itemChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Export Options -->
    {% if stock_data %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-download me-2"></i>Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <button class="btn btn-outline-primary w-100" onclick="exportToCSV()">
                                <i class="fas fa-file-csv me-2"></i>Export CSV
                            </button>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-outline-success w-100" onclick="window.print()">
                                <i class="fas fa-print me-2"></i>Print Report
                            </button>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.stock_entries') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-plus-circle me-2"></i>Add Stock Entry
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('main.stock_issues') }}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-minus-circle me-2"></i>Issue Stock
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if stock_data %}
// Prepare data for charts
const stockData = [
    {% for balance, item, location in stock_data %}
    {
        item: "{{ item.name }}",
        code: "{{ item.code }}",
        balance: {{ balance.balance }},
        location: "{{ location.office }} - {{ location.room_store }}"
    },
    {% endfor %}
];

// Status distribution chart
const statusCounts = {
    inStock: stockData.filter(item => item.balance > 5).length,
    lowStock: stockData.filter(item => item.balance > 0 && item.balance <= 5).length,
    outOfStock: stockData.filter(item => item.balance === 0).length
};

const statusCtx = document.getElementById('statusChart').getContext('2d');
new Chart(statusCtx, {
    type: 'pie',
    data: {
        labels: ['In Stock', 'Low Stock', 'Out of Stock'],
        datasets: [{
            data: [statusCounts.inStock, statusCounts.lowStock, statusCounts.outOfStock],
            backgroundColor: ['#198754', '#ffc107', '#dc3545'],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Top items chart
const topItems = stockData
    .sort((a, b) => b.balance - a.balance)
    .slice(0, 10);

const itemCtx = document.getElementById('itemChart').getContext('2d');
new Chart(itemCtx, {
    type: 'bar',
    data: {
        labels: topItems.map(item => item.code),
        datasets: [{
            label: 'Stock Level',
            data: topItems.map(item => item.balance),
            backgroundColor: topItems.map(item => 
                item.balance === 0 ? '#dc3545' : 
                item.balance <= 5 ? '#ffc107' : '#198754'
            ),
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});
{% endif %}

// CSV Export function
function exportToCSV() {
    const table = document.getElementById('stockTable');
    const rows = Array.from(table.querySelectorAll('tr'));
    
    const csvContent = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.map(cell => {
            // Clean cell content and wrap in quotes if needed
            let content = cell.textContent.trim();
            if (content.includes(',') || content.includes('"') || content.includes('\n')) {
                content = '"' + content.replace(/"/g, '""') + '"';
            }
            return content;
        }).join(',');
    }).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'stock_report_' + new Date().toISOString().split('T')[0] + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Make table sortable
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('stockTable');
    if (table) {
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', () => sortTable(index));
        });
    }
});

function sortTable(columnIndex) {
    const table = document.getElementById('stockTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    const isNumeric = columnIndex === 6; // Balance column
    
    rows.sort((a, b) => {
        const aVal = a.cells[columnIndex].textContent.trim();
        const bVal = b.cells[columnIndex].textContent.trim();
        
        if (isNumeric) {
            return parseInt(bVal) - parseInt(aVal);
        } else {
            return aVal.localeCompare(bVal);
        }
    });
    
    rows.forEach(row => tbody.appendChild(row));
}
</script>

<style>
@media print {
    .btn, .card-header, .navbar, .alert {
        display: none !important;
    }
    
    .card {
        border: none !important;
    }
    
    .table {
        font-size: 12px;
    }
}
</style>
{% endblock %}

{% extends "base.html" %}

{% block title %}Stock Issues - Stock Management System{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-minus-circle me-2"></i>Stock Issue Requests</h2>
                <a href="{{ url_for('main.add_stock_issue') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>New Request
                </a>
            </div>
        </div>
    </div>

    <!-- Add Form -->
    {% if mode == 'add' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Create Stock Issue Request
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.requester_id.label(class="form-label") }}
                                    {{ form.requester_id(class="form-select" + (" is-invalid" if form.requester_id.errors else "")) }}
                                    {% if form.requester_id.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.requester_id.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.department_id.label(class="form-label") }}
                                    {{ form.department_id(class="form-select" + (" is-invalid" if form.department_id.errors else "")) }}
                                    {% if form.department_id.errors %}
                                        <div class="invalid-feedback">
                                            {% for error in form.department_id.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.approval_flow.label(class="form-label") }}
                                    {{ form.approval_flow(class="form-select", id="approvalFlow") }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row" id="approverField" style="display: none;">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    {{ form.approver_id.label(class="form-label") }}
                                    {{ form.approver_id(class="form-select") }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            {{ form.purpose.label(class="form-label") }}
                            {{ form.purpose(class="form-control" + (" is-invalid" if form.purpose.errors else ""), rows="3") }}
                            {% if form.purpose.errors %}
                                <div class="invalid-feedback">
                                    {% for error in form.purpose.errors %}{{ error }}{% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Create Request
                            </button>
                            <a href="{{ url_for('main.stock_issues') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Requests Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Issue Requests ({{ requests|length }} requests)</h5>
                </div>
                <div class="card-body">
                    {% if requests %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Request #</th>
                                        <th>Requester</th>
                                        <th>Department</th>
                                        <th>Purpose</th>
                                        <th>Status</th>
                                        <th>Flow</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in requests %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('main.stock_issue_detail', id=request.id) }}" class="text-decoration-none">
                                                <strong>{{ request.request_number }}</strong>
                                            </a>
                                        </td>
                                        <td>
                                            <strong>{{ request.requester.emp_id }}</strong>
                                            <br>
                                            <small class="text-muted">{{ request.requester.name }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ request.department.code }}</span>
                                        </td>
                                        <td>{{ request.purpose[:50] + '...' if request.purpose|length > 50 else request.purpose }}</td>
                                        <td>
                                            {% set status_class = {
                                                'draft': 'bg-secondary',
                                                'pending': 'bg-warning',
                                                'approved': 'bg-success',
                                                'rejected': 'bg-danger',
                                                'issued': 'bg-info',
                                                'conditional_approved': 'bg-primary'
                                            } %}
                                            <span class="badge {{ status_class.get(request.status, 'bg-secondary') }}">
                                                {{ request.status.replace('_', ' ').title() }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {{ 'bg-info' if request.approval_flow == 'alternate' else 'bg-secondary' }}">
                                                {{ request.approval_flow.title() }}
                                            </span>
                                        </td>
                                        <td>{{ request.created_at.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <a href="{{ url_for('main.stock_issue_detail', id=request.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-minus-circle fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No issue requests found</h5>
                            <p class="text-muted">Start by creating your first stock issue request.</p>
                            <a href="{{ url_for('main.add_stock_issue') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Create First Request
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const approvalFlow = document.getElementById('approvalFlow');
    const approverField = document.getElementById('approverField');
    
    if (approvalFlow) {
        approvalFlow.addEventListener('change', function() {
            if (this.value === 'alternate') {
                approverField.style.display = 'block';
            } else {
                approverField.style.display = 'none';
            }
        });
        
        // Trigger on page load
        if (approvalFlow.value === 'alternate') {
            approverField.style.display = 'block';
        }
    }
});
</script>
{% endblock %}
